import React, {
  FunctionComponent,
  useState,
  useCallback,
  ChangeEvent,
  useMemo,
} from 'react';
import {
  Table,
  TableBody,
  TableContainer,
  Pagination,
  Typography,
} from '@mui/material';

import { ParsedCve } from '../../../types/CVE.types';
import { ParsedApiResponse } from '../../../types/CVE.types';
import {
  TableHeadCell,
  TableOrderByKey,
  TableSortOrder,
} from './types/ResultsTable.types';
import { ResultsTableHead } from './ResultsTableHead';
import { ResultsTableRow } from './ResultsTableRow';

type SearchResultsTableProps = {
  data?: ParsedApiResponse;
  searchTerm?: string;
  defaultOrderBy?: 'id' | 'baseScore' | 'lastModified' | 'published';
  defaultOrder?: 'asc' | 'desc';
  onPageChange: (idx: number) => void;
  disabled: boolean;
};

const headCells: TableHeadCell[] = [
  { id: 'id', label: 'ID' },
  { id: 'published', label: 'Published' },
  { id: 'lastModified', label: 'Modified' },
  { id: 'baseScore', label: 'Score' },
];

function stableSortCves(
  cves: ParsedCve[],
  order: TableSortOrder,
  orderBy: TableOrderByKey
) {
  return cves.sort((a, b) => {
    if (orderBy === 'id') {
      const aId = a.id;
      const bId = b.id;

      return order === 'asc' ? aId.localeCompare(bId) : bId.localeCompare(aId);
    }

    if (orderBy === 'baseScore') {
      const aBaseScore = a.metrics?.baseScore ?? 0;
      const bBaseScore = b.metrics?.baseScore ?? 0;

      return order === 'asc'
        ? aBaseScore - bBaseScore
        : bBaseScore - aBaseScore;
    }

    if (orderBy === 'lastModified') {
      const aLastModified = a.lastModified ?? '';
      const bLastModified = b.lastModified ?? '';

      return order === 'asc'
        ? aLastModified.localeCompare(bLastModified)
        : bLastModified.localeCompare(aLastModified);
    }

    if (orderBy === 'published') {
      const aPublished = a.published ?? '';
      const bPublished = b.published ?? '';

      return order === 'asc'
        ? aPublished.localeCompare(bPublished)
        : bPublished.localeCompare(aPublished);
    }

    return 0;
  });
}

export const SearchResultsTable: FunctionComponent<SearchResultsTableProps> = ({
  data,
  searchTerm,
  defaultOrderBy = 'id',
  defaultOrder = 'asc',
  onPageChange,
  disabled,
}) => {
  const [order, setOrder] = useState<TableSortOrder>(defaultOrder);
  const [orderBy, setOrderBy] = useState<TableOrderByKey>(defaultOrderBy);

  const handleRequestSort = useCallback(
    (event: React.MouseEvent<unknown>, property: TableOrderByKey) => {
      const isAsc = orderBy === property && order === 'asc';

      setOrder(isAsc ? 'desc' : 'asc');
      setOrderBy(property);
    },
    [order, orderBy]
  );

  const handlePageChange = useCallback(
    (event: ChangeEvent<unknown>, idx: number) => {
      onPageChange(idx);
    },
    [onPageChange]
  );

  const itemsRange = useMemo(() => {
    if (!data) {
      return null;
    }

    if (data.startIndex === 0) {
      return `1-${data.cves.length}`;
    }

    const start = data.resultsPerPage * (data.startIndex - 1) + 1;
    const end = data.resultsPerPage * data.startIndex;

    return `${start}-${end}`;
  }, [data]);

  if (!data || !data.cves?.length) {
    return null;
  }

  return (
    <TableContainer>
      {!!itemsRange && (
        <Typography variant='body1' sx={{ marginBottom: '1rem' }}>
          Showing {itemsRange} of {data.totalResults} results{' '}
          {!!searchTerm && `for "${searchTerm}"`}
        </Typography>
      )}

      <Table>
        <ResultsTableHead
          headCells={headCells}
          order={order}
          orderBy={orderBy}
          onRequestSort={handleRequestSort}
        />
        <TableBody>
          {stableSortCves(data.cves, order, orderBy).map(cve => (
            <ResultsTableRow key={cve.id} cve={cve} />
          ))}
        </TableBody>
      </Table>

      <Pagination
        count={Math.ceil(data.totalResults / data.resultsPerPage)}
        page={data.startIndex}
        onChange={handlePageChange}
        size='small'
        sx={{
          display: 'flex',
          justifyContent: 'center',
          marginTop: '1rem',
        }}
        disabled={disabled}
      />
    </TableContainer>
  );
};
