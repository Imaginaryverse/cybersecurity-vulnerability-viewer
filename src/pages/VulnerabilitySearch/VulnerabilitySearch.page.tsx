import React, {
  FunctionComponent,
  useEffect,
  useState,
  useCallback,
} from 'react';
import { isValidKeyword, serializeSearchParams } from '../../utils/stringUtils';
import { useSearchParams } from 'react-router-dom';
import {
  Button,
  CircularProgress,
  Pagination,
  TextField,
  Typography,
} from '@mui/material';
import { useCvesByKeywordQuery } from '../../api/hooks/useCveQuery';
import { SearchResultsTable } from '../../components/organisms/SearchResultsTable';
import { Page } from '../../components/atoms/Page/Page';

export const VulnerabilitySearchPage: FunctionComponent = () => {
  const [searchParams, setSearchParams] = useSearchParams();

  const [keywordInput, setKeywordInput] = useState('');

  const { isLoading, error, data, isPreviousData, refetch } =
    useCvesByKeywordQuery({
      keyword: searchParams.get('keyword') || '',
      pageIndex: Number(searchParams.get('pageIndex')) || 0,
    });

  const handleInutChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      if (e.target.value[0] === ' ') {
        return;
      }

      setKeywordInput(e.target.value);
    },
    [setKeywordInput]
  );

  const handlePageChange = useCallback(
    (event: React.ChangeEvent<unknown>, idx: number) => {
      if (!isPreviousData) {
        setSearchParams(
          serializeSearchParams({
            keyword: searchParams.get('keyword'),
            pageIndex: idx - 1,
          })
        );
      }
    },
    [isPreviousData, searchParams, setSearchParams]
  );

  const searchByKeyword = useCallback(
    (e?: React.FormEvent<HTMLFormElement>) => {
      e?.preventDefault();

      if (!isValidKeyword(keywordInput)) {
        return;
      }

      setSearchParams(
        serializeSearchParams({
          keyword: keywordInput,
          pageIndex: 0,
        })
      );
    },
    [keywordInput, setSearchParams]
  );

  useEffect(() => {
    setKeywordInput(searchParams.get('keyword') || '');
  }, [searchParams]);

  useEffect(() => {
    if (!isValidKeyword(searchParams.get('keyword') ?? '')) {
      return;
    }

    refetch();
  }, [searchParams, refetch]);

  return (
    <Page>
      <Typography variant='h2' component='h1'>
        Search
      </Typography>

      <form
        onSubmit={searchByKeyword}
        style={{
          width: '100%',
          color: 'inherit',
          display: 'flex',
          flexDirection: 'column',
          justifyContent: 'center',
          alignItems: 'center',
          gap: '1rem',
        }}
      >
        <TextField
          id='keyword'
          label='Keyword'
          placeholder='Keyword'
          variant='outlined'
          value={keywordInput}
          onChange={handleInutChange}
          sx={{
            width: '100%',
            maxWidth: '500px',
          }}
          required
          error={!!keywordInput.length && !isValidKeyword(keywordInput)}
          helperText={
            !!keywordInput.length &&
            !isValidKeyword(keywordInput) &&
            'Keyword must be at least 3 alphanumeric characters long'
          }
        />

        <Button
          type='submit'
          variant='contained'
          color='primary'
          disabled={isLoading || !isValidKeyword(keywordInput)}
        >
          {isLoading ? 'Loading...' : 'Search'}
        </Button>
      </form>

      {!!error && (
        <Typography>{`No results found for "${searchParams.get(
          'keyword'
        )}"`}</Typography>
      )}

      {!isLoading && !!data && (
        <Typography>{`Found ${
          data.totalResults
        } results for "${searchParams.get('keyword')}"`}</Typography>
      )}

      {isLoading ? (
        <CircularProgress
          sx={{
            margin: '2rem auto',
          }}
        />
      ) : (
        <SearchResultsTable cves={data?.cves || []} />
      )}

      {!!data && (
        <Pagination
          size='small'
          count={data.maxPage}
          page={Number(searchParams.get('pageIndex')) + 1}
          onChange={handlePageChange}
          disabled={isLoading || isPreviousData}
          sx={{
            alignSelf: 'center',
          }}
        />
      )}
    </Page>
  );
};
