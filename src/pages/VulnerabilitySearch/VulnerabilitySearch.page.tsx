import React, {
  FunctionComponent,
  useEffect,
  useState,
  useCallback,
  useMemo,
} from 'react';
import { isValidKeyword, serializeSearchParams } from '../../utils/stringUtils';
import { useSearchParams } from 'react-router-dom';
import { Box, Link, Typography } from '@mui/material';
import { useCvesByKeywordAndTimeSpanQuery } from '../../api/hooks/useCveQuery';
import { SearchResultsTable } from '../../components/organisms/ResultsTable/ResultsTable';
import { Page } from '../../components/atoms/Page/Page';
import { KeywordSearchForm } from './components/KeywordSearchForm';
import { LoadingSpinner } from '../../components/atoms/LoadingSpinner/LoadingSpinner';
import { TimeSpanType } from '../../types/TimeSpan.types';

export const VulnerabilitySearchPage: FunctionComponent = () => {
  const [searchParams, setSearchParams] = useSearchParams();
  const [keywordInput, setKeywordInput] = useState('');
  const [timeSpan, setTimeSpan] = useState<TimeSpanType>('All Time');

  const keywordSearchParam = useMemo(
    () => searchParams.get('keyword'),
    [searchParams]
  );

  const timeSpanSearchParam = useMemo(
    () => searchParams.get('timeSpan'),
    [searchParams]
  );

  const pageIndexSearchParam = useMemo(
    () => Number(searchParams.get('pageIndex') ?? 0),
    [searchParams]
  );

  const { isLoading, error, data, isPreviousData, refetch } =
    useCvesByKeywordAndTimeSpanQuery({
      keyword: keywordSearchParam || '',
      timeSpan: (timeSpanSearchParam || 'All Time') as TimeSpanType,
      pageIndex: pageIndexSearchParam,
    });

  const handlePageChange = useCallback(
    (idx: number) => {
      if (!isPreviousData) {
        setSearchParams(
          serializeSearchParams({
            keyword: keywordSearchParam,
            timeSpan: timeSpanSearchParam,
            pageIndex: idx,
          })
        );
      }
    },
    [isPreviousData, keywordSearchParam, timeSpanSearchParam, setSearchParams]
  );

  const handleSearchSubmit = useCallback(
    (e?: React.FormEvent<HTMLFormElement>) => {
      e?.preventDefault();

      if (!isValidKeyword(keywordInput)) {
        return;
      }

      setSearchParams(
        serializeSearchParams({
          keyword: keywordInput,
          timeSpan: timeSpan,
          pageIndex: 0,
        })
      );
    },
    [keywordInput, timeSpan, setSearchParams]
  );

  useEffect(() => {
    if (keywordSearchParam && isValidKeyword(keywordSearchParam)) {
      setKeywordInput(keywordSearchParam);
      setTimeSpan((timeSpanSearchParam || 'All Time') as TimeSpanType);
      refetch();
    }
  }, [keywordSearchParam, timeSpanSearchParam, pageIndexSearchParam, refetch]);

  return (
    <Page>
      <Typography variant='h2' component='h1'>
        Search
      </Typography>

      <Box>
        <Typography variant='body1' component='p' gutterBottom>
          Search for vulnerabilities by keyword. We recommend using the{' '}
          <Link
            href='https://cwe.mitre.org/'
            target='_blank'
            rel='noopener noreferrer'
          >
            Common Weakness Enumeration (CWE)
          </Link>{' '}
          identifier for best results.
        </Typography>

        <Typography variant='body1' component='p' gutterBottom>
          Please note that this search is limited to the data available in the
          National Vulnerability Database (NVD). Using a narrow time span may
          return few or no results.
        </Typography>
      </Box>

      <KeywordSearchForm
        keywordInput={keywordInput}
        onKeywordInputChange={setKeywordInput}
        timeSpan={timeSpan}
        onTimeSpanChange={setTimeSpan}
        onSubmit={handleSearchSubmit}
        isLoading={isLoading}
      />

      {!!error && (
        <Typography>{`No results found for "${keywordSearchParam}" and selected time period`}</Typography>
      )}

      {isLoading && <LoadingSpinner />}

      {!isLoading && !!data && (
        <SearchResultsTable
          data={data}
          searchTerm={keywordSearchParam ?? undefined}
          onPageChange={handlePageChange}
          disabled={isLoading || isPreviousData}
        />
      )}
    </Page>
  );
};
