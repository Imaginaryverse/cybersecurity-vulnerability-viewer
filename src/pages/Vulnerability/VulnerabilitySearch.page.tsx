/* eslint-disable react-hooks/exhaustive-deps */
import React, { FunctionComponent, useEffect, useState } from 'react';
import { isValidKeyword } from '../../utils/stringUtils';
import { useNavigate, useSearchParams } from 'react-router-dom';
import {
  Button,
  CircularProgress,
  List,
  ListItem,
  Pagination,
  TextField,
  Typography,
} from '@mui/material';
import { useCvesByKeywordQuery } from '../../api/hooks/useCveQuery';

function serializeSearchParams(
  params: Record<string, string | number | boolean | null | undefined>
) {
  return Object.entries(params)
    .map(([key, value]) => `${key}=${encodeURIComponent(String(value))}`)
    .join('&');
}

export const VulnerabilitySearchPage: FunctionComponent = () => {
  const navigate = useNavigate();
  const [searchParams, setSearchParams] = useSearchParams();

  const [keywordInput, setKeywordInput] = useState('');

  const { isLoading, error, data, isPreviousData, refetch } =
    useCvesByKeywordQuery({
      keyword: searchParams.get('keyword') || '',
      pageIndex: Number(searchParams.get('pageIndex')) || 0,
    });

  function searchByKeyword(e?: React.FormEvent<HTMLFormElement>) {
    e?.preventDefault();

    // Prevent searching if keyword is invalid
    if (!isValidKeyword(keywordInput)) {
      return;
    }

    setSearchParams(
      serializeSearchParams({
        keyword: keywordInput,
        pageIndex: 0,
      })
    );
  }

  useEffect(() => {
    setKeywordInput(searchParams.get('keyword') || '');
  }, [searchParams]);

  useEffect(() => {
    if (!isValidKeyword(searchParams.get('keyword') ?? '')) {
      return;
    }

    refetch();
  }, [searchParams]);

  return (
    <>
      <Typography variant='h1' component='h1'>
        Vulnerabilities
      </Typography>

      <form
        onSubmit={searchByKeyword}
        style={{
          width: '100%',
          maxWidth: '500px',
          color: 'inherit',
          display: 'flex',
          flexDirection: 'column',
          gap: '1rem',
        }}
      >
        <TextField
          id='keyword'
          label='Keyword'
          placeholder='Keyword'
          variant='outlined'
          value={keywordInput}
          onChange={e => setKeywordInput(e.target.value)}
          fullWidth
          required
        />

        <Button
          type='submit'
          variant='contained'
          color='primary'
          disabled={isLoading || !isValidKeyword(keywordInput)}
        >
          {isLoading ? 'Loading...' : 'Search'}
        </Button>
      </form>

      {!!error && (
        <Typography>{`No results found for "${searchParams.get(
          'keyword'
        )}"`}</Typography>
      )}

      {!isLoading && !!data && (
        <Typography>{`Found ${
          data.totalResults
        } results for "${searchParams.get('keyword')}"`}</Typography>
      )}

      {isLoading ? (
        <CircularProgress />
      ) : (
        <List>
          {data?.cves.map(cve => (
            <ListItem key={cve.id}>
              <Typography>{cve.id}</Typography>

              <Button
                variant='contained'
                color='primary'
                onClick={() =>
                  navigate(`/vulnerability/${cve.id}`, {
                    state: {
                      vulnerability: cve,
                    },
                  })
                }
              >
                View
              </Button>
            </ListItem>
          ))}
        </List>
      )}

      {!!data && (
        <Pagination
          variant='outlined'
          count={data.maxPage}
          page={Number(searchParams.get('pageIndex')) + 1}
          onChange={(event, idx) => {
            if (!isPreviousData) {
              setSearchParams(
                serializeSearchParams({
                  keyword: searchParams.get('keyword'),
                  pageIndex: idx - 1,
                })
              );
            }
          }}
          disabled={isLoading || isPreviousData}
        />
      )}
    </>
  );
};
