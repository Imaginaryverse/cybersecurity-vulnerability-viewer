import { FunctionComponent, useEffect } from 'react';
import { Button, Card, Link, Typography } from '@mui/material';
import { Page } from '../../components/atoms/Page/Page';
import { useCvesByTimeSpanQuery } from '../../api/hooks/useCveQuery';
import { LoadingSpinner } from '../../components/atoms/LoadingSpinner/LoadingSpinner';
import { useNavigate } from 'react-router-dom';
import { ResultsStack } from '../../components/organisms/ResultsStack/ResultsStack';
import { SortOptionType } from '../../components/organisms/ResultsStack/types/ResultsStack.types';

export const HomePage: FunctionComponent = () => {
  const navigate = useNavigate();

  const { isLoading, isFetching, error, data, refetch } =
    useCvesByTimeSpanQuery({
      timeSpan: 'Last 48 Hours',
      pageIndex: 0,
    });

  useEffect(() => {
    if (!data && !isFetching) {
      refetch();
    }
  }, [data, isFetching, refetch]);

  return (
    <Page>
      <Typography variant='h2' component='h2'>
        VULN
      </Typography>

      <Card
        sx={{ paddingTop: '1rem', paddingBottom: '2rem', paddingX: '1rem' }}
      >
        <Typography variant='h5' component='h3' gutterBottom>
          Looking for something specific?
        </Typography>

        <Typography variant='body1' component='p' gutterBottom>
          You can search for a specific vulnerability by its CVE ID, or by
          keyword. Click the button below to get started.
        </Typography>

        <Button
          onClick={() => navigate('/vulnerability/search')}
          variant='contained'
          sx={{
            marginTop: '1rem',
            width: 'fit-content',
          }}
        >
          Search by keyword
        </Button>
      </Card>

      <Typography variant='h5' component='h3'>
        Latest entries (last 48 hours)
      </Typography>

      {(isFetching || isLoading) && (
        <Typography variant='body1' component='p'>
          Loading latest vulnerabilities...
        </Typography>
      )}

      {(isFetching || isLoading) && <LoadingSpinner />}

      {(!isFetching || !isLoading) && !!error && (
        <Typography variant='body1' component='p'>
          {error.message}
        </Typography>
      )}

      {(!isFetching || !isLoading) && !!data && (
        <ResultsStack
          data={data}
          defaultSort={SortOptionType.PUBLISHED_NEW_OLD}
          onPageChange={() => null}
          isLoadingData={isLoading}
        />
      )}
    </Page>
  );
};
